# 상태 점검
상태 점검은 오작동이나 장애가 발생했을 때, 애플리케이션을 실행해주는 프로세스가 애플리케이션을 다시 시작하거나 종료하도록 해주기 때문에 중요하다.

### 저자가 추천하는 상태점검 시 기록할 것
비정상 상태에 이르게 된 원인을 어떻게 파악할 것인지에 대한 논의는 시스템의 설계 단계에서부터 이루어져야한다. 상태 점검 시 무엇을 기록할 것인지는 개발자의 마음이지만 본 책의 저자는 아래 4가지를 기록할 것을 추천한다.

1. 데이터 저장소 연결 상태
  - 일반 연결 상태  
    데이터 베이스에 연결되지 않았다는 것은 서비스가 전혀 동작하지 않는다는 것을 의미하기 때문이다.

  - 연결 풀 상태
    완전히 동작이 불가능한 상태는 아니지만 서비스의 부하가 높아 성능이 저하될 수 있기 때문이다.
2. 현재 응답 시간
  - 운영 환경에서 정상 사아태의 기준이 되는 임계치에 대한 밑그림을 그릴 수 있다.
  - 응답 시간에 대해 이동 평균의 값을 기준으로 하는 이유는 하나 또는 두 개의 정상 작동의 표준 편차를 벗어나는 언제든 있을 수 있기 때문이다.  
3. 현재 연결
4. 잘못된 요청
  - 잘못된 요청일 수록 평균 실행 소요시간보다 더 오래 걸릴 가능성이 높다.

### 핸드쉐이크 패턴
각 클라이언트가 실제 요청을 보내기 전에 서버에서 이 요청을 처리할 수 있는지 확인해주는 다운스트림 서비스에 대한 핸드쉐이크 요청을 먼저 보내는 것이다.  
##### 요청을 처리하기 전에 내부 상태 점검을 처음으로 호출하는 것이 좋다.
이렇게 핸드쉐이크 패턴 사용 시, 핸드쉐이크 요청이 실패한다면 클라이언트에게 클러스터 내의 다른 엔드포인트로 접속을 시도할 수 있는 기회를 준다. 이 상태 점검 호출은 아무런 데이터도 처리하지않고 상태 점검 엔드포인트에서 상태 정보만을 읽어오기 때문에, 서버의 처리 시간에 거의 아무런 부담을 주지 않는다.

### Mutex
Mutex는 고루틴의 실행 흐름을 제어하는 대표적인 동기화 객체 Mutex이다.    
상호 배제(mutual exclusion)라고도 하며 여러 스레드(고루틴)에서 공유되는 데이터를 보호할 때 주로 사용합니다.  
[Mutex 참고자료](https://gobyexample.com/mutexes)
##### resetMutex
서비스가 정상이 안닌 경우 서비스가 복구되는 동안 대기하고 평균을 재설정하기 위해 resetMutex에 대한 잠금을 얻는다. 여러 개의 고루틴이 있기 때문에 변수를 뮤텍스로 제어하지 않는 이상 그 변수는 안전하지 않다.

# 쓰로틀링(Throttling)
쓰로틀링은 서비스가 처리할 수 있는 연결 수를 제한하고 이 임계치를 초과하면 HTTP 에러 코드를 리턴하는 패턴이다.
### 쓰임새
시스템에 대한 다중 부하 테스트를 실행해야 하며 엔드포인트에 대한 로깅 및 성능 통계를 조사해야하는 것에 쓰로틀링이 아래와 같은 예시처럼 쓰인다.  
- 핸들러에 연결 수 제한
- CPU 소비 기록  -> 조건이 요구사항 초과 시 실패
